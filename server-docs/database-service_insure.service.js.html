<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>database-service/insure.service.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controller_claim.html">controller/claim</a><ul class='methods'><li data-type='method'><a href="module-controller_claim.html#~checkAuth">checkAuth</a></li><li data-type='method'><a href="module-controller_claim.html#~checkAuthForGet">checkAuthForGet</a></li><li data-type='method'><a href="module-controller_claim.html#~validateClaim">validateClaim</a></li></ul></li><li><a href="module-controller_image.html">controller/image</a><ul class='methods'><li data-type='method'><a href="module-controller_image.html#~deleteImages">deleteImages</a></li><li data-type='method'><a href="module-controller_image.html#~getImage">getImage</a></li><li data-type='method'><a href="module-controller_image.html#~safeImage">safeImage</a></li><li data-type='method'><a href="module-controller_image.html#~uploadImage">uploadImage</a></li></ul></li><li><a href="module-controller_mail.html">controller/mail</a><ul class='methods'><li data-type='method'><a href="module-controller_mail.html#~genClaimLink">genClaimLink</a></li><li data-type='method'><a href="module-controller_mail.html#~genRegLink">genRegLink</a></li><li data-type='method'><a href="module-controller_mail.html#~genRegLinkWithOTPW">genRegLinkWithOTPW</a></li><li data-type='method'><a href="module-controller_mail.html#~sendClaimMail">sendClaimMail</a></li><li data-type='method'><a href="module-controller_mail.html#~sendRegister">sendRegister</a></li><li data-type='method'><a href="module-controller_mail.html#~sendReset">sendReset</a></li><li data-type='method'><a href="module-controller_mail.html#~sendTokenToLinkUserInsured">sendTokenToLinkUserInsured</a></li></ul></li><li><a href="module-controller_search.html">controller/search</a><ul class='methods'><li data-type='method'><a href="module-controller_search.html#~contract">contract</a></li><li data-type='method'><a href="module-controller_search.html#~getLength">getLength</a></li><li data-type='method'><a href="module-controller_search.html#~getRegexScore">getRegexScore</a></li><li data-type='method'><a href="module-controller_search.html#~getResult">getResult</a></li><li data-type='method'><a href="module-controller_search.html#~insured">insured</a></li><li data-type='method'><a href="module-controller_search.html#~miniInsured">miniInsured</a></li><li data-type='method'><a href="module-controller_search.html#~search">search</a></li></ul></li><li><a href="module-controller_token.html">controller/token</a><ul class='methods'><li data-type='method'><a href="module-controller_token.html#~createClaimToken">createClaimToken</a></li><li data-type='method'><a href="module-controller_token.html#~createLinkUserInsuredToken">createLinkUserInsuredToken</a></li><li data-type='method'><a href="module-controller_token.html#~createRegisterToken">createRegisterToken</a></li><li data-type='method'><a href="module-controller_token.html#~createResetToken">createResetToken</a></li><li data-type='method'><a href="module-controller_token.html#~createToken">createToken</a></li></ul></li><li><a href="module-controller_user.html">controller/user</a><ul class='methods'><li data-type='method'><a href="module-controller_user.html#~checkUserObjectAuth">checkUserObjectAuth</a></li><li data-type='method'><a href="module-controller_user.html#~checkUserObjectPartner">checkUserObjectPartner</a></li><li data-type='method'><a href="module-controller_user.html#~generateRandomPassword">generateRandomPassword</a></li><li data-type='method'><a href="module-controller_user.html#~hashPassword">hashPassword</a></li><li data-type='method'><a href="module-controller_user.html#~verifyCredentials">verifyCredentials</a></li><li data-type='method'><a href="module-controller_user.html#~verifyUniqueUser">verifyUniqueUser</a></li></ul></li><li><a href="module-service_agent.html">service/agent</a><ul class='methods'><li data-type='method'><a href="module-service_agent.html#~createAgent">createAgent</a></li><li data-type='method'><a href="module-service_agent.html#~getById">getById</a></li></ul></li><li><a href="module-service_chat.html">service/chat</a><ul class='methods'><li data-type='method'><a href="module-service_chat.html#~createChat">createChat</a></li><li data-type='method'><a href="module-service_chat.html#~getAllChats">getAllChats</a></li><li data-type='method'><a href="module-service_chat.html#~getByBusinessObjectId">getByBusinessObjectId</a></li><li data-type='method'><a href="module-service_chat.html#~getByChatId">getByChatId</a></li></ul></li><li><a href="module-service_claim.html">service/claim</a><ul class='methods'><li data-type='method'><a href="module-service_claim.html#~addImageId">addImageId</a></li><li data-type='method'><a href="module-service_claim.html#~addRating">addRating</a></li><li data-type='method'><a href="module-service_claim.html#~addSchadenssumme">addSchadenssumme</a></li><li data-type='method'><a href="module-service_claim.html#~createClaimCase">createClaimCase</a></li><li data-type='method'><a href="module-service_claim.html#~deleteImage">deleteImage</a></li><li data-type='method'><a href="module-service_claim.html#~postNewClaimcase">postNewClaimcase</a></li><li data-type='method'><a href="module-service_claim.html#~updateById">updateById</a></li><li data-type='method'><a href="module-service_claim.html#~updateClaimCaseBySecret">updateClaimCaseBySecret</a></li><li data-type='method'><a href="module-service_claim.html#~updateClaimCaseStatusById">updateClaimCaseStatusById</a></li></ul></li><li><a href="module-service_clerk.html">service/clerk</a><ul class='methods'><li data-type='method'><a href="module-service_clerk.html#~getById">getById</a></li></ul></li><li><a href="module-service_contract.html">service/contract</a><ul class='methods'><li data-type='method'><a href="module-service_contract.html#~createByContractId">createByContractId</a></li><li data-type='method'><a href="module-service_contract.html#~deleteByContractId">deleteByContractId</a></li><li data-type='method'><a href="module-service_contract.html#~getAll">getAll</a></li><li data-type='method'><a href="module-service_contract.html#~getAllAuth">getAllAuth</a></li><li data-type='method'><a href="module-service_contract.html#~getByContractId">getByContractId</a></li><li data-type='method'><a href="module-service_contract.html#~getByPartnerId">getByPartnerId</a></li><li data-type='method'><a href="module-service_contract.html#~getNumberOfDocuments">getNumberOfDocuments</a></li><li data-type='method'><a href="module-service_contract.html#~search">search</a></li><li data-type='method'><a href="module-service_contract.html#~updateByContractId">updateByContractId</a></li></ul></li><li><a href="module-service_forms.html">service/forms</a><ul class='methods'><li data-type='method'><a href="module-service_forms.html#~getAllForms">getAllForms</a></li><li data-type='method'><a href="module-service_forms.html#~getFormByVersion">getFormByVersion</a></li><li data-type='method'><a href="module-service_forms.html#~postNewClaim">postNewClaim</a></li><li data-type='method'><a href="module-service_forms.html#~postNewForm">postNewForm</a></li><li data-type='method'><a href="module-service_forms.html#~updateForm">updateForm</a></li></ul></li><li><a href="module-service_profile.html">service/profile</a><ul class='methods'><li data-type='method'><a href="module-service_profile.html#~createInsured">createInsured</a></li><li data-type='method'><a href="module-service_profile.html#~deleteByInsuredId">deleteByInsuredId</a></li><li data-type='method'><a href="module-service_profile.html#~getAll">getAll</a></li><li data-type='method'><a href="module-service_profile.html#~getById">getById</a></li><li data-type='method'><a href="module-service_profile.html#~getByInsuredId">getByInsuredId</a></li><li data-type='method'><a href="module-service_profile.html#~getByPartnerId">getByPartnerId</a></li><li data-type='method'><a href="module-service_profile.html#~getCircularReplacer">getCircularReplacer</a></li><li data-type='method'><a href="module-service_profile.html#~getProfileById">getProfileById</a></li><li data-type='method'><a href="module-service_profile.html#~getProfileByPartnerId">getProfileByPartnerId</a></li><li data-type='method'><a href="module-service_profile.html#~linkAgentByInsuredId">linkAgentByInsuredId</a></li><li data-type='method'><a href="module-service_profile.html#~linkClerkByInsuredId">linkClerkByInsuredId</a></li><li data-type='method'><a href="module-service_profile.html#~safeMail">safeMail</a></li><li data-type='method'><a href="module-service_profile.html#~search">search</a></li><li data-type='method'><a href="module-service_profile.html#~updateByInsuredId">updateByInsuredId</a></li><li data-type='method'><a href="module-service_profile.html#~updatetProfileById">updatetProfileById</a></li></ul></li><li></li><li></li><li><a href="module-service_tantant.html">service/tantant</a><ul class='methods'><li data-type='method'><a href="module-service_tantant.html#~createTenant">createTenant</a></li><li data-type='method'><a href="module-service_tantant.html#~deleteById">deleteById</a></li><li data-type='method'><a href="module-service_tantant.html#~getAll">getAll</a></li><li data-type='method'><a href="module-service_tantant.html#~getById">getById</a></li><li data-type='method'><a href="module-service_tantant.html#~getNumberOfDocuments">getNumberOfDocuments</a></li><li data-type='method'><a href="module-service_tantant.html#~updateById">updateById</a></li></ul></li><li><a href="module-service_user.html">service/user</a><ul class='methods'><li data-type='method'><a href="module-service_user.html#~completeRegById">completeRegById</a></li><li data-type='method'><a href="module-service_user.html#~confirmLinkUserInsuredToken">confirmLinkUserInsuredToken</a></li><li data-type='method'><a href="module-service_user.html#~createUser">createUser</a></li><li data-type='method'><a href="module-service_user.html#~getUser">getUser</a></li><li data-type='method'><a href="module-service_user.html#~getUserById">getUserById</a></li><li data-type='method'><a href="module-service_user.html#~getUserByRegToken">getUserByRegToken</a></li><li data-type='method'><a href="module-service_user.html#~getUserByResetToken">getUserByResetToken</a></li><li data-type='method'><a href="module-service_user.html#~updateLinkUserAgent">updateLinkUserAgent</a></li><li data-type='method'><a href="module-service_user.html#~updateLinkUserInsuredToken">updateLinkUserInsuredToken</a></li><li data-type='method'><a href="module-service_user.html#~updateResetToken">updateResetToken</a></li><li data-type='method'><a href="module-service_user.html#~updateUserPassword">updateUserPassword</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#countPerCreateAll">countPerCreateAll</a></li><li><a href="global.html#countPerCreateAuth">countPerCreateAuth</a></li><li><a href="global.html#countPerCreateUser">countPerCreateUser</a></li><li><a href="global.html#countPerStateAll">countPerStateAll</a></li><li><a href="global.html#countPerStateAuth">countPerStateAuth</a></li><li><a href="global.html#countPerStateUser">countPerStateUser</a></li><li><a href="global.html#getAllClaimcases">getAllClaimcases</a></li><li><a href="global.html#getByPartnerId">getByPartnerId</a></li><li><a href="global.html#getClaimCase">getClaimCase</a></li><li><a href="global.html#getClaimCaseBySecret">getClaimCaseBySecret</a></li><li><a href="global.html#getClaimCasesByContractID">getClaimCasesByContractID</a></li><li><a href="global.html#getClaimCasesForAuth">getClaimCasesForAuth</a></li><li><a href="global.html#getClaimCaseWithSecret">getClaimCaseWithSecret</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">database-service/insure.service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
const logger = require('../logger');
const insured = require('./collection-service').insured;
const mongo = require('mongodb');
/** @module service/profile */


/**
 *
 *
 * @param {*} beginAtIndex
 * @param {*} limit
 * @returns insureds
 */
async function getAll(beginAtIndex, limit) {
  const collection = insured();
  try {
    return await collection
      .find()
      .sort({ $natural: -1 })
      .skip(beginAtIndex)
      .limit(limit)
      .toArray();
  } catch (err) {
    logger.error('[insured.service.js] getAll () Error: ' + err);
    return false;
  }
}

/**
 *
 *
 * @param {*} id
 * @returns insured
 */
async function getById(id) {
  const collection = insured();
  try {
    const object_id = new mongo.ObjectID(id);
    return await collection.findOne({ partnerId: object_id });
  } catch (err) {
    logger.error('[insured.service.js] getById (' + id + ') Error: ' + err);
    return false;
  }
}

/**
 *
 *
 * @param {*} id
 * @returns insured
 */
async function getByInsuredId(id) {
  const collection = insured();
  const object_id = new mongo.ObjectID(id);
  return await collection.findOne({ _id: object_id }).then((item) => {
    if (item === null) {
      logger.info(
        "[insured.controller.js] Couldn't find user with query: " +
          JSON.stringify(id)
      );
    } else {
      logger.info(
        '[insured.controller.js] Successfully found ' + JSON.stringify(item)
      );
    }
    return item;
  });
}

/**
 *
 *
 * @param {*} partnerId
 * @returns insured
 */
async function getByPartnerId(partnerId) {
  const collection = insured();
  const object_id = new mongo.ObjectID(partnerId);
  return await collection.findOne({ partnerId: object_id }).then((item) => {
    if (item === null) {
      logger.info(
        "[insured.controller.js] Couldn't find user with query: " +
          JSON.stringify(partnerId)
      );
    } else {
      logger.info(
        '[insured.controller.js] Successfully found ' + JSON.stringify(item)
      );
    }
    return item;
  });
}

/**
 *
 *
 * @param {*} id
 * @param {*} insuredPerson
 * @returns insured
 */
async function updateByInsuredId(id, insuredPerson) {
  const collection = insured();
  try {
    const object_id = new mongo.ObjectID(id);
    return await collection.findOneAndUpdate(
      { _id: object_id },
      { $set: insuredPerson }
    );
  } catch (err) {
    logger.error(
      '[insured.controller.js] updateByInsuredId (' + id + ') Error: ' + err
    );
    return false;
  }
}

/**
 *
 *
 * @param {*} id
 * @param {*} clerkId
 * @returns mongo update object
 */
async function linkClerkByInsuredId(id, clerkId) {
  const collection = insured();

  try {
    const object_id = new mongo.ObjectID(id);
    const object_id_clerkId = new mongo.ObjectID(clerkId);

    return await collection.findOneAndUpdate(
      { _id: object_id },
      { $set: { clerkId: object_id_clerkId } }
    );
  } catch (err) {
    logger.error(
      '[insured.controller.js] linkClerkByInsuredId (' + id + ') Error: ' + err
    );
    return false;
  }
}

/**
 *
 *
 * @param {*} id
 * @param {*} agentId
 * @returns mongo update object
 */
async function linkAgentByInsuredId(id, agentId) {
  const collection = insured();

  try {
    const object_id = new mongo.ObjectID(id);
    const object_id_agentId = new mongo.ObjectID(agentId);

    return await collection.findOneAndUpdate(
      { _id: object_id },
      { $set: { agentId: object_id_agentId } }
    );
  } catch (err) {
    logger.error(
      '[insured.service.js] linkAgentByInsuredId (' + id + ') Error: ' + err
    );
    return false;
  }
}

/**
 *
 *
 * @param {*} id
 * @returns mongo update object
 */
async function deleteByInsuredId(id) {
  const collection = insured();

  try {
    const object_id = new mongo.ObjectID(id);
    return await collection.deleteOne({ _id: object_id });
  } catch (err) {
    logger.error(
      '[insured.controller.js] deleteByInsuredId (' + id + ') Error: ' + err
    );
    return false;
  }
}

/**
 *
 *
 * @param {*} insuredPerson
 * @returns mongo update object
 */
async function createInsured(insuredPerson) {
  const collection = insured();

  if (!!insuredPerson.partnerId) {
    insuredPerson.partnerId = new mongo.ObjectID(insuredPerson.partnerId);
  }
  if (!!insuredPerson.mandantenId) {
    insuredPerson.mandantenId = new mongo.ObjectID(insuredPerson.mandantenId);
  }

  try {
    return await collection.insertOne(insuredPerson);
  } catch (err) {
    logger.error(
      '[insured.service.js] createInsured (' +
        JSON.stringify(insuredPerson) +
        ') Error: ' +
        err
    );
    return false;
  }
}

/**
 *
 *
 * @param {*} search
 * @returns insureds
 */
async function search(search) {
  const collection = insured();

  /*try {
    await collection.createIndex({
      "address.country": "text",
      firstname: "text",
      lastname: "text"
    });
  } catch (err) {
    logger.error("[insured.controller.js] search index problem " + err);
  }*/
  let insuredArray = [];
  try {
    //insuredArray = awai;
    /*t collection
      .aggregate([
        { $match: { $text: { $search: "\"Cathrine\"" } } },
        { $project: { title: 1, _id: 0, score: { $meta: "textScore" } } },
        { $skip: from },
        { $limit: to }
      ])
      .toArray();*/

    insuredArray = await collection
      .aggregate([
        {
          $match: {
            $or: [
              { firstname: { $in: search } },
              {
                lastname: { $in: search },
              },
              {
                'contactData.mail': { $in: search },
              },
              {
                'contactData.telefon': { $in: search },
              },
              {
                'contactData.cellphonenumber': { $in: search },
              },
              {
                'contactData.postOfficeBox': { $in: search },
              },
              {
                'address.streetaddress': { $in: search },
              },
              {
                'address.postcode': { $in: search },
              },
              {
                'address.country': { $in: search },
              },
              {
                'address.state': { $in: search },
              },
            ],
          },
        },
      ])
      .toArray();
  } catch (err) {
    logger.error('[getBySearchTerm] (' + search + '2) ==> ' + err);
  }

  return insuredArray;
}

module.exports = {
  getAll: getAll,
  getById: getById,
  getByInsuredId: getByInsuredId,
  updateByInsuredId: updateByInsuredId,
  linkClerkByInsuredId: linkClerkByInsuredId,
  linkAgentByInsuredId: linkAgentByInsuredId,
  deleteByInsuredId: deleteByInsuredId,
  createInsured: createInsured,
  getByPartnerId: getByPartnerId,
  search: search,
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Thu Jun 11 2020 12:25:00 GMT+0200 (Mitteleuropäische Sommerzeit) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
