<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>database-service/claim-case.service.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controller_claim.html">controller/claim</a><ul class='methods'><li data-type='method'><a href="module-controller_claim.html#~checkAuth">checkAuth</a></li><li data-type='method'><a href="module-controller_claim.html#~checkAuthForGet">checkAuthForGet</a></li><li data-type='method'><a href="module-controller_claim.html#~validateClaim">validateClaim</a></li></ul></li><li><a href="module-controller_image.html">controller/image</a><ul class='methods'><li data-type='method'><a href="module-controller_image.html#~deleteImages">deleteImages</a></li><li data-type='method'><a href="module-controller_image.html#~getImage">getImage</a></li><li data-type='method'><a href="module-controller_image.html#~safeImage">safeImage</a></li><li data-type='method'><a href="module-controller_image.html#~uploadImage">uploadImage</a></li></ul></li><li><a href="module-controller_mail.html">controller/mail</a><ul class='methods'><li data-type='method'><a href="module-controller_mail.html#~genClaimLink">genClaimLink</a></li><li data-type='method'><a href="module-controller_mail.html#~genRegLink">genRegLink</a></li><li data-type='method'><a href="module-controller_mail.html#~genRegLinkWithOTPW">genRegLinkWithOTPW</a></li><li data-type='method'><a href="module-controller_mail.html#~sendClaimMail">sendClaimMail</a></li><li data-type='method'><a href="module-controller_mail.html#~sendRegister">sendRegister</a></li><li data-type='method'><a href="module-controller_mail.html#~sendReset">sendReset</a></li><li data-type='method'><a href="module-controller_mail.html#~sendTokenToLinkUserInsured">sendTokenToLinkUserInsured</a></li></ul></li><li><a href="module-controller_search.html">controller/search</a><ul class='methods'><li data-type='method'><a href="module-controller_search.html#~contract">contract</a></li><li data-type='method'><a href="module-controller_search.html#~getLength">getLength</a></li><li data-type='method'><a href="module-controller_search.html#~getRegexScore">getRegexScore</a></li><li data-type='method'><a href="module-controller_search.html#~getResult">getResult</a></li><li data-type='method'><a href="module-controller_search.html#~insured">insured</a></li><li data-type='method'><a href="module-controller_search.html#~miniInsured">miniInsured</a></li><li data-type='method'><a href="module-controller_search.html#~search">search</a></li></ul></li><li><a href="module-controller_token.html">controller/token</a><ul class='methods'><li data-type='method'><a href="module-controller_token.html#~createClaimToken">createClaimToken</a></li><li data-type='method'><a href="module-controller_token.html#~createLinkUserInsuredToken">createLinkUserInsuredToken</a></li><li data-type='method'><a href="module-controller_token.html#~createRegisterToken">createRegisterToken</a></li><li data-type='method'><a href="module-controller_token.html#~createResetToken">createResetToken</a></li><li data-type='method'><a href="module-controller_token.html#~createToken">createToken</a></li></ul></li><li><a href="module-controller_user.html">controller/user</a><ul class='methods'><li data-type='method'><a href="module-controller_user.html#~checkUserObjectAuth">checkUserObjectAuth</a></li><li data-type='method'><a href="module-controller_user.html#~checkUserObjectPartner">checkUserObjectPartner</a></li><li data-type='method'><a href="module-controller_user.html#~generateRandomPassword">generateRandomPassword</a></li><li data-type='method'><a href="module-controller_user.html#~hashPassword">hashPassword</a></li><li data-type='method'><a href="module-controller_user.html#~verifyCredentials">verifyCredentials</a></li><li data-type='method'><a href="module-controller_user.html#~verifyUniqueUser">verifyUniqueUser</a></li></ul></li><li><a href="module-service_agent.html">service/agent</a><ul class='methods'><li data-type='method'><a href="module-service_agent.html#~createAgent">createAgent</a></li><li data-type='method'><a href="module-service_agent.html#~getById">getById</a></li></ul></li><li><a href="module-service_chat.html">service/chat</a><ul class='methods'><li data-type='method'><a href="module-service_chat.html#~createChat">createChat</a></li><li data-type='method'><a href="module-service_chat.html#~getAllChats">getAllChats</a></li><li data-type='method'><a href="module-service_chat.html#~getByBusinessObjectId">getByBusinessObjectId</a></li><li data-type='method'><a href="module-service_chat.html#~getByChatId">getByChatId</a></li></ul></li><li><a href="module-service_claim.html">service/claim</a><ul class='methods'><li data-type='method'><a href="module-service_claim.html#~addImageId">addImageId</a></li><li data-type='method'><a href="module-service_claim.html#~addRating">addRating</a></li><li data-type='method'><a href="module-service_claim.html#~addSchadenssumme">addSchadenssumme</a></li><li data-type='method'><a href="module-service_claim.html#~createClaimCase">createClaimCase</a></li><li data-type='method'><a href="module-service_claim.html#~deleteImage">deleteImage</a></li><li data-type='method'><a href="module-service_claim.html#~postNewClaimcase">postNewClaimcase</a></li><li data-type='method'><a href="module-service_claim.html#~updateById">updateById</a></li><li data-type='method'><a href="module-service_claim.html#~updateClaimCaseBySecret">updateClaimCaseBySecret</a></li><li data-type='method'><a href="module-service_claim.html#~updateClaimCaseStatusById">updateClaimCaseStatusById</a></li></ul></li><li><a href="module-service_clerk.html">service/clerk</a><ul class='methods'><li data-type='method'><a href="module-service_clerk.html#~getById">getById</a></li></ul></li><li><a href="module-service_contract.html">service/contract</a><ul class='methods'><li data-type='method'><a href="module-service_contract.html#~createByContractId">createByContractId</a></li><li data-type='method'><a href="module-service_contract.html#~deleteByContractId">deleteByContractId</a></li><li data-type='method'><a href="module-service_contract.html#~getAll">getAll</a></li><li data-type='method'><a href="module-service_contract.html#~getAllAuth">getAllAuth</a></li><li data-type='method'><a href="module-service_contract.html#~getByContractId">getByContractId</a></li><li data-type='method'><a href="module-service_contract.html#~getByPartnerId">getByPartnerId</a></li><li data-type='method'><a href="module-service_contract.html#~getNumberOfDocuments">getNumberOfDocuments</a></li><li data-type='method'><a href="module-service_contract.html#~search">search</a></li><li data-type='method'><a href="module-service_contract.html#~updateByContractId">updateByContractId</a></li></ul></li><li><a href="module-service_forms.html">service/forms</a><ul class='methods'><li data-type='method'><a href="module-service_forms.html#~getAllForms">getAllForms</a></li><li data-type='method'><a href="module-service_forms.html#~getFormByVersion">getFormByVersion</a></li><li data-type='method'><a href="module-service_forms.html#~postNewClaim">postNewClaim</a></li><li data-type='method'><a href="module-service_forms.html#~postNewForm">postNewForm</a></li><li data-type='method'><a href="module-service_forms.html#~updateForm">updateForm</a></li></ul></li><li><a href="module-service_profile.html">service/profile</a><ul class='methods'><li data-type='method'><a href="module-service_profile.html#~createInsured">createInsured</a></li><li data-type='method'><a href="module-service_profile.html#~deleteByInsuredId">deleteByInsuredId</a></li><li data-type='method'><a href="module-service_profile.html#~getAll">getAll</a></li><li data-type='method'><a href="module-service_profile.html#~getById">getById</a></li><li data-type='method'><a href="module-service_profile.html#~getByInsuredId">getByInsuredId</a></li><li data-type='method'><a href="module-service_profile.html#~getByPartnerId">getByPartnerId</a></li><li data-type='method'><a href="module-service_profile.html#~getCircularReplacer">getCircularReplacer</a></li><li data-type='method'><a href="module-service_profile.html#~getProfileById">getProfileById</a></li><li data-type='method'><a href="module-service_profile.html#~getProfileByPartnerId">getProfileByPartnerId</a></li><li data-type='method'><a href="module-service_profile.html#~linkAgentByInsuredId">linkAgentByInsuredId</a></li><li data-type='method'><a href="module-service_profile.html#~linkClerkByInsuredId">linkClerkByInsuredId</a></li><li data-type='method'><a href="module-service_profile.html#~safeMail">safeMail</a></li><li data-type='method'><a href="module-service_profile.html#~search">search</a></li><li data-type='method'><a href="module-service_profile.html#~updateByInsuredId">updateByInsuredId</a></li><li data-type='method'><a href="module-service_profile.html#~updatetProfileById">updatetProfileById</a></li></ul></li><li></li><li></li><li><a href="module-service_tantant.html">service/tantant</a><ul class='methods'><li data-type='method'><a href="module-service_tantant.html#~createTenant">createTenant</a></li><li data-type='method'><a href="module-service_tantant.html#~deleteById">deleteById</a></li><li data-type='method'><a href="module-service_tantant.html#~getAll">getAll</a></li><li data-type='method'><a href="module-service_tantant.html#~getById">getById</a></li><li data-type='method'><a href="module-service_tantant.html#~getNumberOfDocuments">getNumberOfDocuments</a></li><li data-type='method'><a href="module-service_tantant.html#~updateById">updateById</a></li></ul></li><li><a href="module-service_user.html">service/user</a><ul class='methods'><li data-type='method'><a href="module-service_user.html#~completeRegById">completeRegById</a></li><li data-type='method'><a href="module-service_user.html#~confirmLinkUserInsuredToken">confirmLinkUserInsuredToken</a></li><li data-type='method'><a href="module-service_user.html#~createUser">createUser</a></li><li data-type='method'><a href="module-service_user.html#~getUser">getUser</a></li><li data-type='method'><a href="module-service_user.html#~getUserById">getUserById</a></li><li data-type='method'><a href="module-service_user.html#~getUserByRegToken">getUserByRegToken</a></li><li data-type='method'><a href="module-service_user.html#~getUserByResetToken">getUserByResetToken</a></li><li data-type='method'><a href="module-service_user.html#~updateLinkUserAgent">updateLinkUserAgent</a></li><li data-type='method'><a href="module-service_user.html#~updateLinkUserInsuredToken">updateLinkUserInsuredToken</a></li><li data-type='method'><a href="module-service_user.html#~updateResetToken">updateResetToken</a></li><li data-type='method'><a href="module-service_user.html#~updateUserPassword">updateUserPassword</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#countPerCreateAll">countPerCreateAll</a></li><li><a href="global.html#countPerCreateAuth">countPerCreateAuth</a></li><li><a href="global.html#countPerCreateUser">countPerCreateUser</a></li><li><a href="global.html#countPerStateAll">countPerStateAll</a></li><li><a href="global.html#countPerStateAuth">countPerStateAuth</a></li><li><a href="global.html#countPerStateUser">countPerStateUser</a></li><li><a href="global.html#getAllClaimcases">getAllClaimcases</a></li><li><a href="global.html#getByPartnerId">getByPartnerId</a></li><li><a href="global.html#getClaimCase">getClaimCase</a></li><li><a href="global.html#getClaimCaseBySecret">getClaimCaseBySecret</a></li><li><a href="global.html#getClaimCasesByContractID">getClaimCasesByContractID</a></li><li><a href="global.html#getClaimCasesForAuth">getClaimCasesForAuth</a></li><li><a href="global.html#getClaimCaseWithSecret">getClaimCaseWithSecret</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">database-service/claim-case.service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
const logger = require('../logger');
const claimcases = require('./collection-service').claimcases;
const mongo = require('mongodb');

/** @module service/claim */

/**
 *
 *
 * @param {*} claimCase
 * @returns mongo update object
 */
async function createClaimCase(claimCase) {
  const collection = claimcases();

  try {
    return await collection.insertOne(claimCase);
  } catch (err) {
    logger.error(
      '[claim-case.controller.js] createClaimCase (' +
        JSON.stringify(claimCase) +
        ') Error: ' +
        err
    );
    return false;
  }
}

/**
 *
 *
 * @param {*} claimCase
 * @param {*} id
 * @returns mongo update object
 */
async function updateById(claimCase, id) {
  const collection = claimcases();

  try {
    const object_id = new mongo.ObjectID(id);
    return await collection.findOneAndUpdate(
      { _id: object_id },
      { $set: claimCase }
    );
  } catch (err) {
    logger.error(
      '[claim-case.controller.js] updateById (' + id + ') Error: ' + err
    );
    return false;
  }
}

/**
 *
 *
 * @param {*} rating
 * @param {*} id
 * @returns mongo update object
 */
async function addRating(rating, id) {
  const collection = claimcases();

  try {
    const object_id = new mongo.ObjectID(id);
    return await collection.findOneAndUpdate(
      { _id: object_id },
      { $set: { rating } },
      {
        returnOriginal: false,
        upsert: true,
        returnNewDocument: true,
      }
    );
  } catch (err) {
    logger.error(
      '[claim-case.controller.js] addRating (' + id + ') Error: ' + err
    );
    return false;
  }
}

/**
 *
 *
 * @param {*} claimsum
 * @param {*} id
 * @returns mongo update object
 */
async function addSchadenssumme(claimsum, id) {
  const collection = claimcases();

  try {
    const object_id = new mongo.ObjectID(id);
    return await collection.findOneAndUpdate(
      { _id: object_id },
      { $set: { schadenssumme: claimsum.schadenssumme } },
      {
        returnOriginal: false,
        upsert: true,
        returnNewDocument: true,
      }
    );
  } catch (err) {
    logger.error(
      '[claim-case.controller.js] addSchadenssumme (' + id + ') Error: ' + err
    );
    return false;
  }
}

/**
 *
 *
 * @param {*} claimid
 * @param {*} imageId
 * @returns mongo update object
 */
async function addImageId(claimid, imageId) {
  const collection = claimcases();
  const object_id = new mongo.ObjectID(claimid);
  for (const key in imageId) {
    if (key == 'tags') {
      continue;
    }
    const element = imageId[key];
    const image_id = new mongo.ObjectID(element);
    imageId[key] = image_id;
  }

  try {
    await collection.findOneAndUpdate(
      { _id: object_id },

      { $addToSet: { images: imageId } }
    );
    return true;
  } catch (err) {
    logger.error(err);
    return false;
  }
}

/**
 *
 *
 * @param {*} claimid
 * @param {*} imageIds
 * @returns mongo update object
 */
async function deleteImage(claimid, imageIds) {
  const collection = claimcases();
  const object_id = new mongo.ObjectID(claimid);
  for (const key in imageIds) {
    const element = imageIds[key];
    const image_id = new mongo.ObjectID(element);
    imageIds[key] = image_id;
  }
  return await collection.findOneAndUpdate(
    { _id: object_id },
    { $pull: { images: imageIds } }
  );
}

/**
 *
 *
 * @param {*} payload
 * @param {*} token
 * @param {*} partnerId
 * @returns mongo update object
 */
async function postNewClaimcase(payload, token, partnerId) {
  const collection = claimcases();
  const object_id_partnerId = new mongo.ObjectID(partnerId);
  payload.contractID = new mongo.ObjectID(payload.contractID);
  try {
    if (!payload.sendMail) {
      return await collection.insertOne({
        payload,
        partnerId: object_id_partnerId,
      });
    } else {
      return await collection.insertOne({
        payload,
        secret: token,
        partnerId: object_id_partnerId,
      });
    }
  } catch (err) {
    logger.error('postClaimCase(' + payload + ') Error:' + err);
    return false;
  }
}

/**
 *
 *
 * @param {*} id
 * @param {*} status
 * @returns mongo update object
 */
async function updateClaimCaseStatusById(id, status) {
  logger.debug(
    'server/database-service/claim-case.service.js updateClaimCaseStatusById(' +
      Date.now() +
      ' - ID: ' +
      id +
      ', Status: ' +
      status +
      ')'
  );
  try {
    const collection = claimcases();
    return await collection.findOneAndUpdate(
      { _id: new mongo.ObjectId(id) },
      {
        $set: { status },
      },
      {
        returnOriginal: false,
        upsert: true,
        returnNewDocument: true,
      }
    );
  } catch (err) {
    logger.error('updateClaimCaseStatusById(' + id + status + ') Error:' + err);
    return false;
  }
}

/**
 *
 *
 * @param {*} claim
 * @returns mongo update object
 */
async function updateClaimCaseBySecret(claim) {
  const collection = claimcases();

  claim.partnerId = new mongo.ObjectID(claim.partnerId);
  claim.contractId = new mongo.ObjectID(claim.contractId);

  delete claim._id;
  // You should not be able to modify the claim history
  delete claim.history;
  try {
    return await collection.findOneAndUpdate(
      { secret: claim.secret },
      {
        $currentDate: {
          'history.lastModified': true,
        },
        $set: claim,
      }
    );
  } catch (err) {
    logger.error('updateClaimCaseBySecret service: (' + claim + ')' + err);
    return false;
  }
}

module.exports = {
  createClaimCase: createClaimCase,
  updateById: updateById,
  addImageId: addImageId,
  postNewClaimcase: postNewClaimcase,
  deleteImage: deleteImage,
  updateClaimCaseStatusById: updateClaimCaseStatusById,
  updateClaimCaseBySecret: updateClaimCaseBySecret,
  addRating: addRating,
  addSchadenssumme: addSchadenssumme,
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Thu Jun 11 2020 12:25:00 GMT+0200 (Mitteleurop√§ische Sommerzeit) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
